<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="icon"
      type="image/x-icon"
      href="https://img.icons8.com/?size=100&id=OzMoRjfKChAo&format=png&color=000000"
    />
    <title>Bill Splitter</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: #f5f5f5;
        padding: 20px;
        min-height: 100vh;
      }

      @media (max-width: 768px) {
        body {
          padding: 10px;
        }
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        padding: 40px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      @media (max-width: 768px) {
        .container {
          padding: 20px;
        }
      }

      @media (max-width: 480px) {
        .container {
          padding: 15px;
        }
      }

      h1 {
        font-size: 24px;
        margin-bottom: 30px;
        color: #333;
      }

      @media (max-width: 480px) {
        h1 {
          font-size: 20px;
          margin-bottom: 20px;
        }
      }

      .controls {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }

      @media (max-width: 480px) {
        .controls {
          flex-direction: column;
        }

        .controls button {
          width: 100%;
        }
      }

      .extras {
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
        padding: 20px;
        background: #f9f9f9;
        border-radius: 8px;
        align-items: flex-end;
      }

      @media (max-width: 768px) {
        .extras {
          flex-direction: column;
          align-items: stretch;
          gap: 15px;
        }
      }

      .extra-field {
        flex: 1;
      }

      .extra-field label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #333;
        font-size: 14px;
      }

      .extra-field input {
        width: 100%;
      }

      .toggle-field {
        flex: 1;
      }

      .toggle-container {
        display: flex;
        background: white;
        border-radius: 6px;
        overflow: hidden;
        border: 2px solid #ddd;
      }

      .toggle-option {
        flex: 1;
        padding: 10px 15px;
        text-align: center;
        cursor: pointer;
        background: white;
        border: none;
        font-size: 14px;
        font-weight: 500;
        color: #666;
        transition: all 0.2s;
      }

      .toggle-option.active {
        background: #4caf50;
        color: white;
      }

      .toggle-option:hover:not(.active) {
        background: #f0f0f0;
      }

      .people-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      @media (max-width: 768px) {
        .people-grid {
          grid-template-columns: 1fr;
          gap: 15px;
        }
      }

      @media (min-width: 769px) and (max-width: 1024px) {
        .people-grid {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      .person-column {
        background: #f9f9f9;
        border-radius: 8px;
        padding: 20px;
        border: 2px solid #e0e0e0;
      }

      .person-header {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
      }

      .person-header input {
        flex: 1;
      }

      .btn-remove-person {
        background: #ff4444;
        color: white;
        padding: 8px 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      }

      .btn-remove-person:hover {
        background: #cc0000;
      }

      .items-list {
        margin-bottom: 15px;
      }

      .item {
        display: flex;
        gap: 8px;
        margin-bottom: 8px;
      }

      .item input[type="text"] {
        flex: 1;
        min-width: 0;
      }

      .item input[type="number"] {
        width: 80px;
      }

      @media (max-width: 480px) {
        .item {
          flex-wrap: wrap;
        }

        .item input[type="text"] {
          width: 100%;
          margin-bottom: 5px;
        }

        .item input[type="number"] {
          flex: 1;
        }
      }

      input {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }

      button {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background 0.2s;
      }

      .btn-add-item {
        background: #2196f3;
        color: white;
        width: 100%;
        padding: 8px;
        font-size: 13px;
      }

      .btn-add-item:hover {
        background: #1976d2;
      }

      .btn-remove-item {
        background: #ff6b6b;
        color: white;
        padding: 8px 10px;
        font-size: 12px;
      }

      .btn-remove-item:hover {
        background: #ff5252;
      }

      .btn-add-person {
        background: #4caf50;
        color: white;
      }

      .btn-add-person:hover {
        background: #45a049;
      }

      .btn-export {
        background: #9c27b0;
        color: white;
      }

      .btn-export:hover {
        background: #7b1fa2;
      }

      .person-total {
        font-weight: 600;
        padding: 10px;
        background: white;
        border-radius: 4px;
        text-align: center;
        margin-top: 10px;
        color: #4caf50;
      }

      .summary {
        margin-top: 30px;
        padding: 30px;
        background: #f0f0f0;
        border-radius: 8px;
      }

      @media (max-width: 768px) {
        .summary {
          padding: 20px;
        }
      }

      @media (max-width: 480px) {
        .summary {
          padding: 15px;
        }
      }

      .summary h2 {
        font-size: 18px;
        margin-bottom: 20px;
        color: #333;
      }

      @media (max-width: 480px) {
        .summary h2 {
          font-size: 16px;
          margin-bottom: 15px;
        }
      }

      .summary-item {
        display: flex;
        justify-content: space-between;
        padding: 12px 0;
        border-bottom: 1px solid #ddd;
      }

      .summary-item:last-child {
        border-bottom: none;
      }

      @media (max-width: 480px) {
        .summary-item {
          flex-direction: column;
          gap: 8px;
          padding: 10px 0;
        }

        .summary-item strong:last-child {
          text-align: left;
          font-size: 18px;
        }
      }

      .summary-total {
        font-size: 20px;
        font-weight: 600;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 2px solid #333;
        display: flex;
        justify-content: space-between;
      }

      @media (max-width: 480px) {
        .summary-total {
          font-size: 18px;
        }
      }

      .percentage {
        color: #666;
        font-size: 14px;
      }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  </head>
  <body>
    <div class="container" id="capture">
      <h1>Bill Splitter</h1>

      <div class="controls">
        <button class="btn-add-person" onclick="addPerson()">
          ðŸ‘¤ Add Person
        </button>
        <button class="btn-export" onclick="exportImage()">
          ðŸ“¸ Export as Image
        </button>
      </div>

      <div class="extras">
        <div class="extra-field">
          <label>Tax ($)</label>
          <input
            type="number"
            id="taxAmount"
            placeholder="0.00"
            step="0.01"
            value="0"
            oninput="render()"
          />
        </div>
        <div class="extra-field">
          <label>Tip ($)</label>
          <input
            type="number"
            id="tipAmount"
            placeholder="0.00"
            step="0.01"
            value="0"
            oninput="render()"
          />
        </div>
        <div class="toggle-field">
          <label>Split Method</label>
          <div class="toggle-container">
            <button
              class="toggle-option active"
              id="proportionalBtn"
              onclick="setSplitMethod('proportional')"
            >
              Proportional
            </button>
            <button
              class="toggle-option"
              id="evenBtn"
              onclick="setSplitMethod('even')"
            >
              Even Split
            </button>
          </div>
        </div>
      </div>

      <div class="people-grid" id="peopleGrid"></div>

      <div class="summary" id="summary"></div>
    </div>

    <script>
      let people = [];
      let nextPersonId = 1;
      let nextItemId = 1;
      let splitMethod = "proportional"; // 'proportional' or 'even'

      function setSplitMethod(method) {
        splitMethod = method;
        document
          .getElementById("proportionalBtn")
          .classList.toggle("active", method === "proportional");
        document
          .getElementById("evenBtn")
          .classList.toggle("active", method === "even");
        updateAllPersonTotals();
        renderSummary();
      }

      function addPerson() {
        people.push({
          id: nextPersonId++,
          name: "",
          items: [],
        });
        render();
      }

      function removePerson(personId) {
        people = people.filter((p) => p.id !== personId);
        render();
      }

      function updatePersonName(personId, name) {
        const person = people.find((p) => p.id === personId);
        if (person) {
          person.name = name;
          renderSummary(); // Only update summary, not full render
        }
      }

      function addItem(personId) {
        const person = people.find((p) => p.id === personId);
        if (person) {
          person.items.push({
            id: nextItemId++,
            name: "",
            price: 0,
          });
          render();
        }
      }

      function removeItem(personId, itemId) {
        const person = people.find((p) => p.id === personId);
        if (person) {
          person.items = person.items.filter((i) => i.id !== itemId);
          render();
        }
      }

      function updateItem(personId, itemId, field, value) {
        const person = people.find((p) => p.id === personId);
        if (person) {
          const item = person.items.find((i) => i.id === itemId);
          if (item) {
            item[field] = field === "price" ? parseFloat(value) || 0 : value;
            updateAllPersonTotals();
            renderSummary();
          }
        }
      }

      function updateAllPersonTotals() {
        const { totals } = calculateTotals();

        totals.forEach((personData) => {
          const personColumn = document.querySelector(
            `[data-person-id="${personData.id}"]`
          );
          if (personColumn) {
            const totalDiv = personColumn.querySelector(".person-total");
            if (totalDiv) {
              totalDiv.innerHTML = `
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">
                                Subtotal: $${personData.subtotal.toFixed(2)}<br>
                                Tax: $${personData.tax.toFixed(2)}<br>
                                Tip: $${personData.tip.toFixed(2)}
                            </div>
                            <div style="font-size: 16px; font-weight: 700;">
                                Total: $${personData.total.toFixed(2)}
                            </div>
                        `;
            }
          }
        });
      }

      function calculateTotals() {
        const subtotal = people.reduce(
          (sum, p) =>
            sum + p.items.reduce((itemSum, item) => itemSum + item.price, 0),
          0
        );

        const taxAmount =
          parseFloat(document.getElementById("taxAmount").value) || 0;
        const tipAmount =
          parseFloat(document.getElementById("tipAmount").value) || 0;

        const totals = people.map((p) => {
          const personSubtotal = p.items.reduce(
            (sum, item) => sum + item.price,
            0
          );

          let personTax, personTip, proportion;

          if (splitMethod === "even") {
            // Split evenly among all people
            const numPeople = people.length;
            personTax = numPeople > 0 ? taxAmount / numPeople : 0;
            personTip = numPeople > 0 ? tipAmount / numPeople : 0;
            proportion = numPeople > 0 ? 1 / numPeople : 0;
          } else {
            // Split proportionally based on what each person spent
            proportion = subtotal > 0 ? personSubtotal / subtotal : 0;
            personTax = taxAmount * proportion;
            personTip = tipAmount * proportion;
          }

          const total = personSubtotal + personTax + personTip;

          return {
            ...p,
            subtotal: personSubtotal,
            tax: personTax,
            tip: personTip,
            total: total,
            proportion: proportion,
          };
        });

        const grandTotal = subtotal + taxAmount + tipAmount;
        return { totals, grandTotal, subtotal, taxAmount, tipAmount };
      }

      function render() {
        renderGrid();
        renderSummary();
      }

      function renderGrid() {
        const grid = document.getElementById("peopleGrid");
        const { totals } = calculateTotals();

        grid.innerHTML = people
          .map((person) => {
            const personData = totals.find((t) => t.id === person.id);

            return `
                    <div class="person-column" data-person-id="${person.id}">
                        <div class="person-header">
                            <input 
                                type="text" 
                                placeholder="Name" 
                                value="${person.name}"
                                onblur="updatePersonName(${
                                  person.id
                                }, this.value)"
                                onkeypress="if(event.key === 'Enter') { this.blur(); }"
                            />
                            <button class="btn-remove-person" onclick="removePerson(${
                              person.id
                            })">Ã—</button>
                        </div>
                        
                        <div class="items-list">
                            ${person.items
                              .map(
                                (item) => `
                                <div class="item">
                                    <input 
                                        type="text" 
                                        placeholder="Item" 
                                        value="${item.name}"
                                        onblur="updateItem(${person.id}, ${
                                  item.id
                                }, 'name', this.value)"
                                        onkeypress="if(event.key === 'Enter') { this.blur(); }"
                                    />
                                    <input 
                                        type="number" 
                                        placeholder="0.00" 
                                        step="0.01"
                                        value="${item.price || ""}"
                                        onblur="updateItem(${person.id}, ${
                                  item.id
                                }, 'price', this.value)"
                                        onkeypress="if(event.key === 'Enter') { this.blur(); }"
                                    />
                                    <button class="btn-remove-item" onclick="removeItem(${
                                      person.id
                                    }, ${item.id})">Ã—</button>
                                </div>
                            `
                              )
                              .join("")}
                        </div>
                        
                        <button class="btn-add-item" onclick="addItem(${
                          person.id
                        })">+ Add Item</button>
                        
                        <div class="person-total">
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">
                                Subtotal: $${personData.subtotal.toFixed(2)}<br>
                                Tax: $${personData.tax.toFixed(2)}<br>
                                Tip: $${personData.tip.toFixed(2)}
                            </div>
                            <div style="font-size: 16px; font-weight: 700;">
                                Total: $${personData.total.toFixed(2)}
                            </div>
                        </div>
                    </div>
                `;
          })
          .join("");
      }

      function renderSummary() {
        const { totals, grandTotal, subtotal, taxAmount, tipAmount } =
          calculateTotals();
        const summaryDiv = document.getElementById("summary");

        if (people.length > 0 && grandTotal > 0) {
          summaryDiv.innerHTML = `
                    <h2>Summary</h2>
                    ${totals
                      .map((person) => {
                        const percentage = (
                          (person.total / grandTotal) *
                          100
                        ).toFixed(1);
                        return `
                            <div class="summary-item">
                                <div style="flex: 1;">
                                    <strong>${person.name || "Unnamed"}</strong>
                                    <span class="percentage"> (${percentage}% of total)</span>
                                    <div style="font-size: 13px; color: #666; margin-top: 8px; line-height: 1.6;">
                                        ${
                                          person.items.length > 0
                                            ? person.items
                                                .map(
                                                  (item) =>
                                                    `â€¢ ${
                                                      item.name || "Item"
                                                    }: $${item.price.toFixed(
                                                      2
                                                    )}`
                                                )
                                                .join("<br>")
                                            : "â€¢ No items"
                                        }
                                        <br><span style="color: #888;">Subtotal: $${person.subtotal.toFixed(
                                          2
                                        )}</span>
                                        <br><span style="color: #888;">Tax: $${person.tax.toFixed(
                                          2
                                        )}</span>
                                        <br><span style="color: #888;">Tip: $${person.tip.toFixed(
                                          2
                                        )}</span>
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <strong style="font-size: 18px; color: #4CAF50;">$${person.total.toFixed(
                                      2
                                    )}</strong>
                                </div>
                            </div>
                        `;
                      })
                      .join("")}
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #ccc; color: #666; font-size: 14px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>Items Subtotal:</span>
                            <span>$${subtotal.toFixed(2)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>Tax:</span>
                            <span>$${taxAmount.toFixed(2)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>Tip:</span>
                            <span>$${tipAmount.toFixed(2)}</span>
                        </div>
                    </div>
                    <div class="summary-total">
                        <span>Total Bill</span>
                        <span>$${grandTotal.toFixed(2)}</span>
                    </div>
                `;
        } else {
          summaryDiv.innerHTML = "";
        }
      }

      async function exportImage() {
        const element = document.getElementById("summary");

        // Check if there's content to export
        if (!element.innerHTML) {
          alert("Please add some items before exporting.");
          return;
        }

        try {
          const canvas = await html2canvas(element, {
            backgroundColor: "#f0f0f0",
            scale: 2,
          });

          // Convert to blob and download
          canvas.toBlob((blob) => {
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "bill-split-" + new Date().getTime() + ".png";
            a.click();
            URL.revokeObjectURL(url);
          });
        } catch (error) {
          console.error("Export failed:", error);
          alert("Failed to export image. Please try again.");
        }
      }

      // Initialize with 2 people
      addPerson();
      addPerson();
    </script>
  </body>
</html>
